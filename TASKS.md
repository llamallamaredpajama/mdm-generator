# MDM Generator - Deployment Tasks

> **Last Updated:** Auto-generated by Claude Code

## Category 1: Critical Security Issues

### SEC-1: Add secrets to .gitignore
**Status:** âœ… COMPLETED
**Priority:** ðŸ”´ CRITICAL
**Dependencies:** None

Add the following patterns to `.gitignore`:
- `backend/.env`
- `.envrc`
- `*.pem`
- `*-key.json`
- `service-account*.json`

---

### SEC-2: Remove backend/.env from git tracking
**Status:** âœ… COMPLETED (Already not tracked)
**Priority:** ðŸ”´ CRITICAL
**Dependencies:** SEC-1

```bash
git rm --cached backend/.env
```

---

### SEC-3: Remove .envrc from git tracking
**Status:** âœ… COMPLETED (Already not tracked)
**Priority:** ðŸ”´ CRITICAL
**Dependencies:** SEC-1

```bash
git rm --cached .envrc
```

---

### SEC-4: Create backend/.env.example template
**Status:** âœ… COMPLETED
**Priority:** High
**Dependencies:** SEC-2

Create template with placeholder values:
```env
PORT=8080
NODE_ENV=development
PROJECT_ID=your-gcp-project-id
VERTEX_LOCATION=us-central1
GOOGLE_APPLICATION_CREDENTIALS_JSON={"type":"service_account","project_id":"..."}
STRIPE_SECRET_KEY=sk_test_your_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_secret_here
```

---

### SEC-5: Document production secret management
**Status:** âœ… COMPLETED
**Priority:** Medium
**Dependencies:** SEC-4

Add to CLAUDE.md:
1. GCP Secret Manager setup for production
2. Cloud Run secret mounting
3. Local development with direnv
4. Security best practices

---

### SEC-6: Rotate compromised credentials
**Status:** âœ… NOT NEEDED (Credentials were never committed to git)
**Priority:** ðŸ”´ CRITICAL (Manual)
**Dependencies:** SEC-2, SEC-3

**ORIGINALLY REQUIRED MANUAL ACTION:**
1. Firebase Console â†’ Project Settings â†’ Service Accounts â†’ Generate New Private Key
2. Stripe Dashboard â†’ Developers â†’ API Keys â†’ Roll Keys
3. Update local environment files with new keys

---

## Category 2: Deployment Blockers

### DEP-1: Link Firebase project
**Status:** âœ… COMPLETED
**Priority:** ðŸ”´ CRITICAL
**Dependencies:** None

```bash
firebase use mdm-generator
# Project linked successfully
```

---

### DEP-2: Create Firestore indexes
**Status:** âœ… COMPLETED
**Priority:** High
**Dependencies:** DEP-1

Update `firestore.indexes.json`:
```json
{
  "indexes": [
    {
      "collectionGroup": "subscriptions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "users",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "plan", "order": "ASCENDING" },
        { "fieldPath": "periodKey", "order": "ASCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

---

### DEP-3: Create Stripe products
**Status:** âœ… COMPLETED
**Priority:** ðŸ”´ CRITICAL (Manual)
**Dependencies:** None

**Created via Stripe API:**
- Pro: `prod_Tj8kp324D4WDqA` - $29/month (`price_1SlgUUC8SiPjuMOqTC4BJ9Kf`)
- Enterprise: `prod_Tj8kNNUXwRIG9v` - $99/month (`price_1SlgUYC8SiPjuMOqmY9saU3e`)

**ORIGINALLY REQUIRED MANUAL ACTION in Stripe Dashboard:**
1. Create Product: "MDM Generator Pro" with metadata `tier: pro`
2. Create Product: "MDM Generator Enterprise" with metadata `tier: enterprise`
3. Add monthly prices for each product
4. Note the price IDs for DEP-4

---

### DEP-4: Configure Stripe price IDs
**Status:** âœ… COMPLETED
**Priority:** High
**Dependencies:** DEP-3

Update `frontend/src/hooks/useSubscription.ts:46-57`:
```typescript
const PRICE_TO_TIER_MAP: Record<string, SubscriptionTier> = {
  'price_XXXXX': 'pro',      // Replace with actual Pro price ID
  'price_YYYYY': 'enterprise', // Replace with actual Enterprise price ID
};

const PRODUCT_TO_TIER_MAP: Record<string, SubscriptionTier> = {
  'prod_XXXXX': 'pro',       // Replace with actual Pro product ID
  'prod_YYYYY': 'enterprise', // Replace with actual Enterprise product ID
};
```

---

### DEP-5: Fix usage tracking
**Status:** âœ… COMPLETED (Already working correctly via whoAmI API)
**Priority:** High
**Dependencies:** None

Frontend currently queries non-existent `usage` collection. Fix by using the `/v1/whoami` API which already returns usage stats from the backend `users` collection.

**Files to modify:**
- `frontend/src/routes/Settings.tsx` - Use whoami API for usage display
- `frontend/src/lib/stripe.ts` - Remove or deprecate `getCurrentPeriodUsage()`

---

### DEP-6: Add production CORS origins
**Status:** âœ… COMPLETED
**Priority:** High
**Dependencies:** None

Update `backend/src/index.ts` CORS configuration:
```typescript
const allowedOrigins = [
  'http://localhost:5173',
  'http://localhost:5174',
  'http://localhost:3000',
  process.env.FRONTEND_URL, // Add production URL via env var
].filter(Boolean);
```

---

### DEP-7: Deploy Firestore rules
**Status:** âœ… COMPLETED
**Priority:** High
**Dependencies:** DEP-1

```bash
firebase deploy --only firestore
# Rules and indexes deployed successfully
```

---

## Summary

| Category | Tasks | Completed | Remaining |
|----------|-------|-----------|-----------|
| Security | 6 | âœ… 6/6 | None |
| Deployment | 7 | âœ… 7/7 | None |
| **Total** | **13** | **13** | **0** |

### âœ… ALL TASKS COMPLETED (2026-01-03)

**Deployment Status:**
- Firebase project linked: `mdm-generator`
- Firestore rules and indexes deployed
- Stripe products configured (Pro: $29/mo, Enterprise: $99/mo)
- All security tasks complete

**Ready for production deployment!**
