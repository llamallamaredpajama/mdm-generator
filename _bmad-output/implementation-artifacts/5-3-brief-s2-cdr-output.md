# Story 5.3: Brief S2 CDR Output

Status: ready-for-dev

| Field          | Value                                                  |
|----------------|--------------------------------------------------------|
| Story ID       | BM-5.3                                                  |
| Points         | 3                                                       |
| Dependencies   | BM-3.3 (CDR State Persistence), BM-4.1 (Result Entry)   |
| Epic           | Phase 5: S2 Intelligence                                 |
| Priority       | Medium (replaces MdmPreviewPanel for S2 context)         |

---

## Story

**As an** Emergency Medicine physician using Build Mode,
**I want** the Section 2 output to show a brief CDR calculations report with my working diagnosis, test result summary, and CDR scores instead of a full MDM preview,
**so that** I can see actionable clinical decision data before proceeding to Section 3.

---

## Acceptance Criteria

1. After S2 submission, output shows working diagnosis (if set)
2. Output shows test result summary: X tests resulted, Y abnormal, with list of abnormals
3. Output shows completed CDR scores with one-line interpretation
4. Each CDR score is expandable to show component breakdown
5. No disposition guidance or MDM complexity in the output
6. "Continue to Section 3" contextual note at the bottom
7. MdmPreviewPanel is replaced by CdrResultsOutput in the S2 preview slot
8. The MdmPreview data still generates on the backend (for S3 prompt) — only the frontend display changes
9. `cd frontend && pnpm check` passes (typecheck + lint + test)
10. `cd backend && pnpm build` passes

---

## Tasks / Subtasks

### 1. Create CdrResultsOutput Component (AC: #1-6)

- [ ] Create `frontend/src/components/build-mode/shared/CdrResultsOutput.tsx`
- [ ] Props: `encounter: EncounterDocument` (read working diagnosis, test results, CDR tracking)
- [ ] Display sections:
  - Working diagnosis (from `encounter.section2.workingDiagnosis`)
  - Result summary: total tests, responded count, abnormal count + list of abnormal test names
  - CDR scores: completed CDRs with score and interpretation, expandable to show components
  - Pending CDRs: list of CDRs still pending or partial
- [ ] Footer note: "Complete Section 3 to generate your final MDM"

### 2. Create CdrResultsOutput CSS (AC: #1-6)

- [ ] BEM-styled component matching existing design language
- [ ] Expandable/collapsible CDR sections with chevron toggle
- [ ] Status badges for CDR scores (color-coded by risk level)

### 3. Swap S2 Preview in EncounterEditor (AC: #7, #8)

- [ ] Replace MdmPreviewPanel in `getSectionPreview` case 2 with CdrResultsOutput
- [ ] Pass encounter directly instead of extracting mdmPreview
- [ ] Keep MdmPreviewPanel file (still used by other code paths, e.g., if needed for backward compat)
- [ ] MdmPreview still generated by backend — no backend changes needed

### 4. Create Tests (AC: #9)

- [ ] Test CdrResultsOutput renders working diagnosis
- [ ] Test CdrResultsOutput shows result summary counts
- [ ] Test expandable CDR sections toggle open/closed
- [ ] Test completed CDRs show score and interpretation
- [ ] Test pending CDRs shown appropriately

---

## Dev Notes

**Architecture Decisions:**
- No backend changes needed — all data is already on the encounter document
- MdmPreview still generates on S2 submission (for S3 prompt consumption) — we only change the frontend display
- CdrResultsOutput reads directly from `encounter.cdrTracking`, `encounter.section2.testResults`, and `encounter.section2.workingDiagnosis`
- MdmPreviewPanel is NOT deleted — it may be needed for backward compatibility or future use

**Key Patterns:**
- Expandable sections pattern from existing MdmPreviewPanel (chevron toggle)
- CDR display pattern from CdrCard component (score badges, component breakdown)
- BEM CSS naming consistent with other shared/ components

**What NOT to Build:**
- No backend prompt changes
- No new API endpoint
- No changes to S2 response schema
- No deletion of MdmPreviewPanel (keep for backward compat)
