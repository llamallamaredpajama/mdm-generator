# Retrospective — Build Mode Rebuild (Epics 1-8)

**Date:** 2026-02-24
**Scope:** Full project retrospective covering all 8 epics before merge to main
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Jeremy (Project Lead)

---

## Project Summary

| Metric | Value |
|--------|-------|
| Epics completed | 8/8 (100%) |
| Stories completed | 25/25 (100%) |
| Total story points | 93 |
| Commits | 36 |
| Files changed | 216 |
| Lines added | 30,373 |
| Lines removed | 1,075 |
| Final test count | 288 (all passing, 2.6s runtime) |

### Phase Breakdown

| Phase | Epic | Stories | Points | Focus |
|-------|------|---------|--------|-------|
| 1 | Data Foundation | 4 | 16 | Test library, CDR library, schema extensions, user profiles |
| 2 | S1 Dashboard | 4 | 15 | 4-area responsive dashboard, workup card, CDR summary, trends |
| 3 | CDR System | 3 | 13 | Matching endpoint, detail views, cross-section persistence |
| 4 | S2 Results Redesign | 3 | 11 | Result entry cards, quick actions, working diagnosis |
| 5 | S2 Intelligence | 3 | 11 | Paste lab parsing, dictation mode, brief CDR output |
| 6 | S3 Redesign | 3 | 11 | Treatment input, disposition selector, structured finalize |
| 7 | Order Sets | 2 | 8 | Save/suggest order sets, report templates |
| 8 | Persistence & Polish | 3 | 11 | S2 refactor, desktop layout, accessibility |

---

## What Went Well

### Architecture & Design
- **Progressive enhancement approach** — 8 phases, always working, never a broken state
- **Backward compatibility maintained throughout** — `getDifferential()` dual-shape handler, `string | WorkingDiagnosis` union type, optional fields with defensive defaults. Zero data migration needed.
- **Clean view-switching** — `BuildMode.tsx` at 143 lines, single responsibility
- **Local content state pattern** — `useEncounter` keeps `localContent` separate from Firestore, merges at read time. No keystroke-level Firestore writes.
- **Progressive prompt accumulation** — `buildFinalizePrompt` takes full clinical picture from all three sections. Each section enriches the next.
- **Prompt builders as pure functions** — deterministic, trivially unit-testable
- **Section progression enforced at both layers** — client-side `canSubmitSection()` + server-side checks

### Patterns That Scaled
- **Optimistic CDR updates with debounce flush-on-unmount** — used across test results, CDR tracking, working diagnosis
- **localStorage-first personalization** — order sets, disposition flows, report templates all use identical hook pattern
- **Single hook owner pattern** — `DashboardOutput` owns `useTestLibrary` + `useCdrLibrary`, passes data down. Prevents duplicate API calls.
- **Batch update pattern** (breakthrough in BM-4.2) — separates "user confirms explicit action" (immediate write) from "keystroke input" (debounced)

### Quality & Safety
- **PHI discipline perfect** — zero contamination across 40+ audit log sites
- **Zero TODO/FIXME/HACK comments** in production code
- **108 ARIA attributes** across build-mode components
- **Dedicated accessibility test file** — 33 test blocks covering 5 components
- **Behavior-first testing throughout** — `@testing-library/react` with user-visible queries
- **Story-traceable tests** — headers map to story IDs for requirement traceability

### Process
- **QA caught real medical safety bugs** — Ottawa Knee/Ankle ID-label swaps (BM-1.2), CDR cross-reference inconsistencies
- **Adversarial review added value** — caught "pre-checked checkboxes" that were actually unchecked (BM-2.2)
- **Consistent commit discipline** — 36 semantic commits, one per story, clean history

---

## What Needed Attention

### Pre-Merge Fixes (Completed During Retro)

**1. Character Limit Mismatch — FIXED ✅**
- Frontend: all sections at 2000 chars. Backend: S1=4000, S2=3000, S3=2500.
- Physicians hit a phantom wall on long narratives.
- **Fix:** Aligned backend to 2000 for all sections. Updated backend schemas, tests, and comments.

**2. `catch (e: any)` → `console.error(e)` PHI Pipeline — FIXED ✅**
- 11 catch blocks in `index.ts` used `catch (e: any)` and logged full error objects.
- Zod validation errors could include stringified narrative content in Cloud Run logs.
- **Fix:** All 11 converted to `catch (e: unknown)` with `e instanceof Error ? e.message : 'unknown error'`. Zero `catch (e: any)` remaining.

### Recurring Challenges During Development

| Challenge | Stories Affected | Resolution |
|-----------|-----------------|------------|
| Firestore type serialization (`Timestamp.now()` → JSON) | BM-1.4 | Created `serializeUserDoc()` helper |
| Array data loss on partial updates (Zod `.default([])`) | BM-1.4 | Separate create/update schemas |
| Duplicate hook calls triggering parallel API requests | BM-2.2 | Single hook owner pattern |
| Debounced Firestore writes lost on unmount | BM-2.2 | `pendingRef` with flush on cleanup |
| PHI leaks in error logging (full error objects) | BM-3.2, index.ts | `.message` only extraction |
| CSS breakpoint inconsistency (640px vs 767px) | BM-2.1 | Standardized to 767px in new files |
| Async state sync (expandedCdrs not tracking new CDRs) | BM-3.2 | Effect to sync when cdrTracking updates |
| Medical content truncation (`text-overflow: ellipsis`) | BM-2.1 | Changed to `word-break: break-word` |

---

## Architecture Debt (Post-Merge Tracking)

### High Priority

| Item | Detail | Recommendation |
|------|--------|----------------|
| **EncounterEditor god component** | 1,306 lines, ~20 imports, 8+ internal callbacks. Every new feature touches this file. | Extract `Section1Panel`, `Section2Panel`, `Section3Panel` sub-orchestrators |
| **`index.ts` route monolith** | 2,424 lines, all routes in one file. Surveillance correctly uses separate `routes.ts`. | Split into `routes/buildMode.ts`, `routes/templates.ts`, `routes/library.ts` |
| **Zero backend tests for Build Mode** | 3 new endpoints + prompt builders + schemas untested. Backend correctness drives clinical output. | Add schema validation tests, prompt builder tests, route handler tests |
| **`useEncounter` untested** | Core state hook managing encounter lifecycle, Firestore sync, all submissions. Zero tests. | Integration test: create encounter → submit S1 → verify state transition |

### Medium Priority

| Item | Detail | Recommendation |
|------|--------|----------------|
| **Dual Firestore deserialization paths** | `useEncounterList.convertEncounterDoc()` and `useEncounter` onSnapshot both manually deserialize with slightly different defaults | Extract shared `deserializeEncounterDocument()` function |
| **Flat `SectionDataSchema`** | S2/S3 fields in one schema. No compile-time guarantee S1 can't carry `disposition`. | Per-section Zod schemas with `.merge()` for shared base |
| **10 hooks without tests** | `useCdrTracking`, `useDispoFlows`, `useMediaQuery`, `useEncounterList`, etc. | Add focused hook tests for the 4 highest-risk hooks |
| **`EncounterEditor` untested** | Main editor orchestrating all sections. No integration test. | Partial test: render with S1 data → verify dashboard → verify nav |
| **CSS breakpoint split** | 12 legacy files use 768px, new standard is 767px. 1px viewport disagreement. | Single cleanup pass to align all to 767px |

### Low Priority

| Item | Detail |
|------|--------|
| Empty `__fixtures__/` — ~15 duplicate mock definitions across test files | Extract shared fixtures |
| `FinalMdm` double type casts (`as unknown as FinalMdm`) in 2 files | Replace with type guard |
| Dead `mode` parameter in `useEncounterList` | Remove or implement filtering |
| Legacy `addListener` Safari <14 fallback in `useMediaQuery.ts` | Remove if Safari <14 no longer supported |
| Quick/Build mode document structure overlap (ghost fields) | Consider discriminated union type |

---

## Testing Landscape

| Category | Coverage |
|----------|----------|
| Test files | 27 |
| Total tests | 288 (all passing) |
| Test runtime | 2.6s |
| Build-mode components with tests | ~16 of 35 (46%) |
| Hooks with tests | 4 of 14 (29%) |
| Routes with tests | 0 of 7 (0%) |
| Backend tests for new endpoints | 0 |

### Testing Strengths
- Behavior-first testing (`getByText`, `getByRole`, not internal state)
- Dedicated accessibility test file (33 blocks, 5 components)
- Edge case coverage (null/undefined, empty arrays, error states, backward compat)
- Consistent mock pattern (`vi.hoisted()` + `vi.mock()`)
- Story-traceable test headers

### Testing Gaps (Priority Order)
1. Backend tests for Build Mode endpoints (highest risk for medical tool)
2. `useEncounter` integration test
3. Shared test fixtures extraction
4. Smoke test per route
5. `EncounterEditor` integration test

---

## Established Patterns (Reference for Future Development)

### Data & State
- **Debounced Firestore writes** with unmount flush via refs
- **Batch updates** (immediate) vs keystroke updates (debounced)
- **Single hook owner** for shared API data, pass via props
- **Defensive defaults** on all optional Firestore fields (`?? defaultValue` in onSnapshot)
- **Union types** for backward compatibility (`string | WorkingDiagnosis`)

### UI & Components
- **BEM CSS naming** with CSS variables + fallbacks
- **`useIsMobile()` hook** at 767px breakpoint for responsive switching
- **Card pattern**: surface background, 1px border, 8px radius, 1rem padding
- **Urgency colors**: hardcoded (clinical meaning), not CSS variables
- **Expandable/collapsible sections**: chevron toggle + conditional render

### Backend
- **6-step API route pattern**: AUTHENTICATE → VALIDATE → AUTHORIZE → EXECUTE → AUDIT → RESPOND
- **`catch (e: unknown)`** with `e instanceof Error ? e.message : 'unknown error'`
- **Audit logging**: metadata only (`{ userId, action, timestamp }`), never medical content
- **Zod schemas as single source of truth** with `z.infer<>` for TypeScript types
- **Pure function prompt builders** — no hidden dependencies, trivially testable

### Personalization
- **localStorage-first** for physician preferences (order sets, templates, disposition flows)
- **Identical hook pattern** across all three: load/save/delete/CRUD
- **Optional, non-blocking** — enhancements to workflow, not gating logic

---

## Key Lessons Learned

1. **Medical content requires special UX care** — no truncation on diagnosis names, preview-before-apply on AI parsing, worst-first ordering
2. **Firestore Timestamp doesn't serialize cleanly** — always convert to ISO string before returning from API
3. **Schema reuse for create/update causes data loss** — Zod `.default([])` on create schemas clears optional fields on PUT. Use separate schemas.
4. **Adversarial review catches what regular review misses** — 30-40% of issues found only in second-pass review
5. **Cross-story ID consistency needs automated validation** — CDR IDs in `feedsCdrs`, test IDs in mappings. Manual verification is error-prone.
6. **`catch (e: any)` is a PHI risk** in a medical app — full error objects can contain narrative content
7. **Single hook owner prevents duplicate API calls** — learned the hard way in BM-2.2

---

## Next Steps

1. **Merge `build-mode-refactor` → `main`** — pre-merge fixes complete, all gates passing
2. **Address high-priority debt** — EncounterEditor split, backend tests, `index.ts` route split
3. **Review action items in next standup** — ensure ownership is clear
4. **Begin next feature work** when preparation complete

---

*Generated during team retrospective on 2026-02-24. All specialist analyses (code quality, architecture, testing) incorporated.*
